<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raju Kirana (Parchi Order)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root { 
            --primary: #6c5ce7; --secondary: #a29bfe; --accent: #00b894;
            --bg: #dfe6e9; --text: #2d3436; --card-bg: rgba(255, 255, 255, 0.96); 
            --glass: blur(12px) saturate(180%); --radius: 18px;
        }
        body.dark-mode { 
            --bg: #0f0c29; --text: #dfe6e9; --card-bg: rgba(30, 30, 30, 0.9); 
            --primary: #8e44ad;
        }
        body { font-family: 'Outfit', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 120px; transition: 0.3s; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        .header { position: sticky; top: 0; z-index: 1000; padding: 15px 20px 10px; background: rgba(255,255,255,0.92); backdrop-filter: blur(15px); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .dark-mode .header { background: rgba(15, 12, 41, 0.95); }
        
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .brand { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        
        /* ICONS */
        .icon-btn { width: 34px; height: 34px; border-radius: 50%; background: rgba(0,0,0,0.05); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; font-size: 16px; }
        .icon-btn:active { transform: scale(0.9); }
        .cart-icon-box { position: relative; margin: 0 8px; cursor: pointer; padding: 5px; }
        .cart-badge { position: absolute; top: -2px; right: -5px; background: #ff4757; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: none; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; }

        /* BUTTONS */
        .btn-small { background: var(--text); color: var(--bg); border: none; padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .qty-compact { display: flex; align-items: center; background: var(--primary); color: white; border-radius: 8px; height: 28px; padding: 0 4px; }
        .qty-btn-c { width: 24px; height: 100%; background: transparent; border: none; color: white; font-weight: bold; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* PARCHI FAB (New) */
        .parchi-fab { position: fixed; bottom: 90px; left: 20px; background: #ff7675; color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 26px; box-shadow: 0 10px 25px rgba(255, 118, 117, 0.4); z-index: 2000; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 118, 117, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); } }

        /* TOGGLE & GRID */
        .del-toggle-box { background: rgba(0,0,0,0.05); padding: 4px; border-radius: 12px; display: flex; margin-bottom: 15px; }
        .del-opt { flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 700; border-radius: 10px; cursor: pointer; opacity: 0.6; transition: 0.3s; }
        .del-opt.selected { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 1; }
        .dark-mode .del-opt.selected { background: #444; color: white; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 10px 15px; }
        .card { background: var(--card-bg); border-radius: 18px; padding: 10px; position: relative; animation: fadeInUp 0.4s; box-shadow: 0 2px 10px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.04); }
        .card-img { height: 120px; background: rgba(0,0,0,0.03); border-radius: 14px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 8px; }
        .card img { max-width: 90%; max-height: 90%; object-fit: contain; transition: 0.3s; }
        
        .search-box { width: 100%; padding: 12px 15px; border-radius: 12px; background: rgba(0,0,0,0.05); border: none; outline: none; color: var(--text); margin-bottom: 10px; font-family: inherit; font-size: 15px; }
        .cat-row { display: flex; gap: 8px; overflow-x: auto; padding: 0 15px 10px; scrollbar-width: none; }
        .cat-btn { background: var(--card-bg); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 13px; color: var(--text); border: 1px solid rgba(0,0,0,0.05); opacity: 0.7; white-space: nowrap; }
        .cat-btn.active { background: var(--primary); color: white; opacity: 1; border-color: transparent; }
        
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #2d3436; color: white; padding: 12px 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 3000; animation: slideUp 0.3s; }
        .fab { position: fixed; bottom: 90px; right: 20px; background: var(--text); color: var(--bg); width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 26px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(6px); }
        .modal-box { background: var(--bg); color: var(--text); padding: 25px; width: 88%; max-width: 360px; border-radius: 24px; max-height: 85vh; overflow-y: auto; animation: popIn 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
        .inp { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 12px; background: rgba(0,0,0,0.05); color: var(--text); font-family: inherit; font-weight: 600; }
        .admin-dash { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(108, 92, 231, 0.3); }
        
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 40px 20px; opacity: 0.7; }
        .empty-icon { font-size: 50px; margin-bottom: 10px; filter: grayscale(1); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .slider-container { height: 50px; background: #e0e0e0; border-radius: 25px; position: relative; overflow: hidden; margin-top: 15px; }
        .slider-container.active { background: var(--accent); }
        .slider-thumb { width: 42px; height: 42px; background: white; border-radius: 50%; position: absolute; top: 4px; left: 4px; display: flex; justify-content: center; align-items: center; color: var(--primary); font-weight: bold; cursor: grab; z-index: 2; transition: transform 0.1s, background 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .toast { position: fixed; bottom: 85px; left: 50%; transform: translate(-50%, 20px); background: #2d3436; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 6000; font-size: 14px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body>

<div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9000;display:flex;justify-content:center;align-items:center;"><div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #6c5ce7;border-radius:50%;animation:spin 1s linear infinite;"></div></div>
<style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
<div id="toast" class="toast">Success</div>

<div id="login-view" class="overlay" style="display: flex; background: var(--primary);">
    <div class="modal-box glass" style="background: rgba(255,255,255,0.98); text-align:center;">
        <div style="font-size:50px; margin-bottom:10px;">üõçÔ∏è</div>
        <h2 style="color:var(--primary); margin:0 0 5px;">Raju Kirana</h2>
        <p style="margin-bottom:20px; font-size:13px; color:#777;">Aapki Apni Digital Dukan</p>
        <input type="text" id="loginName" class="inp" placeholder="Enter Your Name">
        <input type="tel" id="loginPhone" class="inp" placeholder="Mobile Number">
        <button class="btn-small" style="width:100%; padding:15px; font-size:16px; margin-top:10px;" onclick="handleLogin()">Login to Shop</button>
    </div>
</div>

<div id="app-view" style="display:none;">
    <div class="header">
        <div class="top-row">
            <div class="brand">üõçÔ∏è Raju Kirana</div>
            <div style="display:flex; align-items:center;">
                <div class="icon-btn" onclick="shareApp()" style="margin-right:8px;" title="Share App">üì§</div>
                <div class="cart-icon-box" onclick="openBillPreview()">
                    <span style="font-size:24px;">üõí</span>
                    <div id="cart-badge" class="cart-badge">0</div>
                </div>
                <div class="icon-btn" onclick="toggleTheme()" style="margin-right:8px;">üåì</div>
                <div onclick="handleLogout()" style="padding:8px 12px; background:rgba(0,0,0,0.05); border-radius:18px; font-size:11px; font-weight:700; cursor:pointer;">EXIT</div>
            </div>
        </div>
        <input type="text" id="search" class="search-box" placeholder="Search atta, dal, rice..." onkeyup="render()">
    </div>

    <div id="admin-panel" style="display:none; padding:0 15px;">
        <div class="admin-dash">
            <h3 style="margin:0; font-size:18px;">Business Panel üõ°Ô∏è</h3>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <div>Total Products<br><b style="font-size:22px;" id="adm-prod-count">0</b></div>
                <div style="text-align:right;">Status<br><b style="font-size:22px; color:#55efc4;">Active</b></div>
            </div>
            <button class="btn-small" style="background:rgba(255,255,255,0.25); width:100%; margin-top:15px; color:white;" onclick="showOrders()">View Order History</button>
        </div>
    </div>

    <div class="cat-row">
        <button class="cat-btn active" onclick="filter('All', this)">All</button>
        <button class="cat-btn" onclick="filter('Rashan', this)">Rashan</button>
        <button class="cat-btn" onclick="filter('Snacks', this)">Snacks</button>
        <button class="cat-btn" onclick="filter('Offers', this)">Offers</button>
    </div>

    <div class="grid" id="grid"></div>
    
    <div class="fab" id="admin-fab" style="display:none;" onclick="openAddModal()">+</div>
    
    <div class="parchi-fab" onclick="document.getElementById('parchiInput').click()">üì∑</div>
    <input type="file" id="parchiInput" hidden accept="image/*" onchange="handleParchiUpload()">

    <div class="cart-bar" id="cart-bar" style="display:none;">
        <div><div style="font-size:11px; opacity:0.7;">TOTAL</div><div style="font-size:20px; font-weight:800;">‚Çπ<span id="cart-total">0</span></div></div>
        <div onclick="openBillPreview()" style="background:white; color:black; padding:10px 24px; border-radius:25px; font-weight:700; font-size:14px; cursor:pointer;">Checkout ‚ûú</div>
    </div>
</div>

<div id="parchi-modal" class="overlay">
    <div class="modal-box">
        <h3>Parchi Order üìù</h3>
        <p style="font-size:12px; color:gray; margin-bottom:10px;">Send handwritten list photo to Raju.</p>
        <img id="parchiPreview" src="" style="width:100%; height:200px; object-fit:contain; background:#f5f5f5; border-radius:10px; margin-bottom:15px;">
        <button id="sendParchiBtn" class="btn-small" style="width:100%; padding:15px; font-size:16px;" onclick="sendParchi()">Send to Raju üöÄ</button>
        <button onclick="document.getElementById('parchi-modal').style.display='none'" style="margin-top:10px; background:none; border:none; color:var(--text); width:100%;">Cancel</button>
    </div>
</div>

<div id="add-modal" class="overlay">
    <div class="modal-box">
        <h3>Add Product</h3>
        <input type="file" id="fileInput" hidden onchange="handleImageUpload()">
        <div onclick="document.getElementById('fileInput').click()" style="border:2px dashed var(--primary); padding:20px; text-align:center; border-radius:15px; margin-bottom:15px; cursor:pointer; color:var(--primary); background:rgba(108, 92, 231, 0.05);">üì∏ Upload Photo</div>
        <img id="imgPreview" src="" style="display:none; width:100%; height:120px; object-fit:contain; margin-bottom:15px; border-radius:10px;">
        <input type="text" id="pName" class="inp" placeholder="Product Name">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="text" id="pUnit" class="inp" placeholder="Unit (e.g. 1kg)">
            <input type="number" id="pPrice" class="inp" placeholder="Price (‚Çπ)">
        </div>
        <select id="pCat" class="inp"><option>Rashan</option><option>Snacks</option><option>Offers</option></select>
        <button id="saveBtn" class="btn-small" style="width:100%; font-size:16px; padding:15px; margin-top:10px;" onclick="saveProduct()">Save Product</button>
        <button onclick="document.getElementById('add-modal').style.display='none'" style="margin-top:10px; background:none; border:none; color:var(--text); width:100%; font-weight:600;">Cancel</button>
    </div>
</div>

<div id="bill-modal" class="overlay">
    <div class="modal-box">
        <h2 style="margin:0 0 20px;">Invoice üßæ</h2>
        <div class="del-toggle-box">
            <div id="opt-del" class="del-opt selected" onclick="toggleDeliveryMode('delivery')">üöö Home Delivery</div>
            <div id="opt-pick" class="del-opt" onclick="toggleDeliveryMode('pickup')">üè¨ Self Pickup</div>
        </div>
        <div style="background:white; color:#333; padding:20px; border-radius:18px; box-shadow:0 5px 20px rgba(0,0,0,0.05); margin-bottom:20px;">
            <div id="bill-list" style="max-height:25vh; overflow-y:auto; border-bottom:1px solid #eee; margin-bottom:10px;"></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;"><span>Items Total</span><span>‚Çπ<span id="b-item-total">0</span></span></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; color:var(--primary); margin-bottom:10px;"><span>Delivery Fee</span><span id="b-delivery">‚Çπ0</span></div>
            <div style="display:flex; justify-content:space-between; font-weight:800; font-size:20px; padding-top:10px; border-top:2px dashed #ccc;"><span>Payable</span><span>‚Çπ<span id="b-grand-total">0</span></span></div>
        </div>
        <div id="addr-section"><textarea id="deliveryAddr" class="inp" rows="2" placeholder="üìç Enter Village Name / Landmark"></textarea></div>
        <div id="pickup-msg" style="display:none; text-align:center; color:green; font-weight:700; font-size:14px; margin-bottom:10px; background:#e0ffe0; padding:10px; border-radius:10px;">‚úÖ You will pick up from Shop</div>
        <div class="slider-container" id="sliderContainer"><div class="slider-thumb" id="sliderThumb">‚ûú</div><div id="sliderText" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; font-weight:700; color:#777; pointer-events:none;">SLIDE TO CONFIRM ORDER</div></div>
        <button onclick="document.getElementById('bill-modal').style.display='none'" style="margin-top:15px; background:none; border:none; color:var(--text); width:100%; font-weight:600;">Close</button>
    </div>
</div>

<div id="history-modal" class="overlay"><div class="modal-box"><h3>Order History</h3><div id="history-list"></div><button class="btn-small" style="width:100%; margin-top:15px; background:#333;" onclick="document.getElementById('history-modal').style.display='none'">Close</button></div></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAYKEYZZVtq9e8k9LemxxSBEDU9oie7vjI",
        authDomain: "raju-kirana.firebaseapp.com",
        projectId: "raju-kirana",
        storageBucket: "raju-kirana.firebasestorage.app",
        messagingSenderId: "9931410245",
        appId: "1:9931410245:web:97e3237c29a85c06e84c2c"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let products = [], cart = {}, user = null, isAdmin = false, activeCat = 'All';
    let tempImgBase64 = "", parchiImgBase64 = "", isPickupMode = false;
    const ADMIN_PIN = "1234";

    window.onload = function() {
        if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
        const u = localStorage.getItem('raju_user');
        
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('order')) showBillMode();
        else if(urlParams.get('parchi')) showParchiMode();
        else if(u) {
            user = JSON.parse(u);
            if(user.name === "Admin" && user.phone === "6392") isAdmin = true;
            showApp();
        } else { document.getElementById('loader').style.display='none'; }
        initSlider();
    };

    function showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }

    function handleLogin() {
        const n = document.getElementById('loginName').value.trim();
        const p = document.getElementById('loginPhone').value.trim();
        if(!n || !p) { showToast("Fill all details!"); return; }
        if(n === "Admin" && p === "6392") {
            const pin = prompt("Enter Admin PIN:");
            if(pin !== ADMIN_PIN) { showToast("Wrong PIN!"); return; }
        } else if (p.length !== 10) { showToast("Invalid Mobile Number"); return; }
        user = {name:n, phone:p}; localStorage.setItem('raju_user', JSON.stringify(user)); location.reload();
    }
    function handleLogout() { localStorage.removeItem('raju_user'); location.reload(); }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); }

    function shareApp() {
        const shareData = { title: 'Raju Kirana', text: 'Order rashan online!', url: window.location.href.split('?')[0] };
        if (navigator.share) navigator.share(shareData).catch(console.error);
        else window.open(`https://wa.me/?text=${encodeURIComponent(shareData.text + " " + shareData.url)}`, '_blank');
    }

    function showApp() {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        if(isAdmin) { document.getElementById('admin-fab').style.display='flex'; document.getElementById('admin-panel').style.display='block'; }
        db.collection("products").onSnapshot(snap => {
            products = []; snap.forEach(d => products.push({id:d.id, ...d.data()}));
            render(); 
            if(isAdmin) document.getElementById('adm-prod-count').innerText = products.length;
            document.getElementById('loader').style.display='none';
        });
    }

    function render() {
        const g = document.getElementById('grid'); g.innerHTML = '';
        const term = document.getElementById('search').value.toLowerCase();
        const filtered = products.filter(p => (activeCat==='All'||p.cat===activeCat) && p.name.toLowerCase().includes(term));
        if(filtered.length === 0) { g.innerHTML = `<div class="empty-state"><div class="empty-icon">üçû</div><h3>No Products Found</h3></div>`; return; }
        filtered.forEach(p => {
            const q = cart[p.id]||0;
            const btn = q===0 ? `<button class="btn-small" onclick="updateQty('${p.id}',1)">ADD</button>` : `<div class="qty-compact"><button class="qty-btn-c" onclick="updateQty('${p.id}',-1)">‚àí</button><span style="font-size:12px; font-weight:700; min-width:15px; text-align:center;">${q}</span><button class="qty-btn-c" onclick="updateQty('${p.id}',1)">+</button></div>`;
            const delBtn = isAdmin ? `<div style="position:absolute;top:5px;right:5px;background:rgba(255,255,255,0.8);padding:4px;border-radius:50%;font-size:10px;cursor:pointer;" onclick="delProd('${p.id}')">üóëÔ∏è</div>` : '';
            g.innerHTML += `<div class="card">${delBtn}<div class="card-img"><img src="${p.img}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'"></div><div style="font-weight:700; font-size:14px; line-height:1.2;">${p.name}</div><div style="font-size:11px;color:gray; margin-bottom:5px;">${p.unit}</div><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:800;color:var(--primary);">‚Çπ${p.price}</span>${btn}</div></div>`;
        });
    }

    function updateQty(id, chg) { if(!cart[id]) cart[id]=0; cart[id]+=chg; if(cart[id]<=0) delete cart[id]; render(); updateFooter(); }
    
    function updateFooter() {
        let t = 0; let c = 0; for(let id in cart) { t += products.find(x=>x.id==id).price * cart[id]; c += cart[id]; }
        document.getElementById('cart-total').innerText = t;
        document.getElementById('cart-bar').style.display = t>0 ? 'flex' : 'none';
        const badge = document.getElementById('cart-badge'); if(c > 0) { badge.innerText = c; badge.style.display = 'flex'; } else { badge.style.display = 'none'; }
    }

    function openBillPreview() {
        if(Object.keys(cart).length === 0) { showToast("Cart is Empty!"); return; }
        const l = document.getElementById('bill-list'); l.innerHTML = ''; let t = 0;
        for(let id in cart) { const p = products.find(x=>x.id==id), cost = p.price*cart[id]; t+=cost; l.innerHTML += `<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px;"><span>${p.name} x${cart[id]}</span><span>‚Çπ${cost}</span></div>`; }
        document.getElementById('b-item-total').innerText = t;
        toggleDeliveryMode('delivery'); resetSlider(); document.getElementById('bill-modal').style.display = 'flex';
    }

    function toggleDeliveryMode(mode) {
        isPickupMode = (mode === 'pickup');
        const itemTotal = parseInt(document.getElementById('b-item-total').innerText);
        const delEl = document.getElementById('b-delivery');
        document.getElementById('opt-del').classList.remove('selected'); document.getElementById('opt-pick').classList.remove('selected');
        if (isPickupMode) {
            document.getElementById('opt-pick').classList.add('selected'); document.getElementById('addr-section').style.display = 'none'; document.getElementById('pickup-msg').style.display = 'block';
            delEl.innerText = "‚Çπ0"; delEl.style.color = "green"; document.getElementById('b-grand-total').innerText = itemTotal;
        } else {
            document.getElementById('opt-del').classList.add('selected'); document.getElementById('addr-section').style.display = 'block'; document.getElementById('pickup-msg').style.display = 'none';
            let fee = itemTotal < 200 ? 20 : 0; delEl.innerText = fee === 0 ? "FREE" : "‚Çπ" + fee; delEl.style.color = fee === 0 ? "green" : "red"; document.getElementById('b-grand-total').innerText = itemTotal + fee;
        }
    }

    // --- PARCHI LOGIC ---
    function handleParchiUpload() {
        const f = document.getElementById('parchiInput').files[0];
        if(f) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const sc = 600/img.width; c.width=600; c.height=img.height*sc;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    parchiImgBase64 = c.toDataURL('image/jpeg',0.6);
                    document.getElementById('parchiPreview').src = parchiImgBase64;
                    document.getElementById('parchi-modal').style.display='flex';
                }
            };
            r.readAsDataURL(f);
        }
    }

    function sendParchi() {
        const btn = document.getElementById('sendParchiBtn');
        btn.innerText = "Sending..."; btn.disabled = true;
        const ord = { c: user.name, p: user.phone, type: 'parchi', img: parchiImgBase64, date: new Date().toLocaleString() };
        db.collection("orders").add(ord).then((docRef) => {
            const link = window.location.href.split('?')[0] + '?parchi=' + docRef.id;
            const msg = `*New Parchi Order* üì∏\nüë§ ${user.name}\nüìû ${user.phone}\nüîó View Photo: ${link}`;
            window.open(`https://wa.me/6392728836?text=${encodeURIComponent(msg)}`, '_blank');
            document.getElementById('parchi-modal').style.display='none'; btn.innerText = "Send to Raju üöÄ"; btn.disabled = false;
        }).catch(e => { showToast("Error sending parchi"); btn.disabled = false; });
    }

    function showParchiMode() {
        const id = new URLSearchParams(window.location.search).get('parchi');
        document.body.innerHTML = `<div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9000;display:flex;justify-content:center;align-items:center;">Loading Parchi...</div>`;
        db.collection("orders").doc(id).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                document.body.innerHTML = `<div style="padding:20px;text-align:center;font-family:sans-serif;"><h2>Parchi Order</h2><p>${d.c} | ${d.p}</p><img src="${d.img}" style="width:100%;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);"><br><br><a href="${window.location.href.split('?')[0]}" style="background:#6c5ce7;color:white;padding:10px 20px;text-decoration:none;border-radius:20px;">Go Home</a></div>`;
            } else { document.body.innerHTML = "Order not found"; }
        });
    }

    // --- PRODUCT UPLOAD ---
    function handleImageUpload() {
        const f = document.getElementById('fileInput').files[0];
        if(f) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const sc = 400/img.width; c.width=400; c.height=img.height*sc;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    tempImgBase64 = c.toDataURL('image/jpeg',0.6);
                    document.getElementById('imgPreview').src = tempImgBase64; document.getElementById('imgPreview').style.display='block';
                }
            };
            r.readAsDataURL(f);
        }
    }

    function saveProduct() {
        const n = document.getElementById('pName').value, u = document.getElementById('pUnit').value, p = document.getElementById('pPrice').value;
        const img = tempImgBase64 || "https://via.placeholder.com/150";
        if(n && p) {
            document.getElementById('saveBtn').innerText="Saving...";
            db.collection("products").add({name:n, unit:u, price:parseInt(p), cat:document.getElementById('pCat').value, img:img, createdAt:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{ document.getElementById('add-modal').style.display='none'; showToast("Product Saved!"); document.getElementById('saveBtn').innerText="Save Product"; document.getElementById('pName').value=''; tempImgBase64=""; document.getElementById('imgPreview').style.display='none'; });
        }
    }
    
    function delProd(id) { if(confirm("Delete?") && prompt("Admin PIN:")===ADMIN_PIN) db.collection("products").doc(id).delete(); }
    function openAddModal() { document.getElementById('add-modal').style.display='flex'; }
    function filter(c, b) { activeCat=c; document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(); }
    
    function initSlider() {
        const t = document.getElementById('sliderThumb'), c = document.getElementById('sliderContainer');
        let isDrag=false, startX;
        t.addEventListener('touchstart', e=>{if(!t.classList.contains('ok')){isDrag=true; startX=e.touches[0].clientX;}});
        t.addEventListener('mousedown', e=>{if(!t.classList.contains('ok')){isDrag=true; startX=e.clientX;}});
        const move = (cx) => { if(!isDrag) return; let x = cx - startX; let max = c.offsetWidth - t.offsetWidth - 10; if(x<0) x=0; if(x>max) x=max; t.style.transform = `translateX(${x}px)`; if(x > max*0.9) { isDrag=false; finishSlider(); } }
        document.addEventListener('touchmove', e=>move(e.touches[0].clientX)); document.addEventListener('mousemove', e=>move(e.clientX));
        document.addEventListener('touchend', ()=>{if(isDrag){isDrag=false; t.style.transform='translateX(0)';}}); document.addEventListener('mouseup', ()=>{if(isDrag){isDrag=false; t.style.transform='translateX(0)';}});
    }
    
    function finishSlider() {
        const t = document.getElementById('sliderThumb');
        t.classList.add('ok'); t.innerHTML='‚úî'; t.style.left='auto'; t.style.right='5px';
        document.getElementById('sliderContainer').classList.add('active');
        document.getElementById('sliderText').innerText="ORDER CONFIRMED!";
        document.getElementById('sliderText').style.color="white";
        setTimeout(sendOrder, 600);
    }
    
    function resetSlider() {
        const t = document.getElementById('sliderThumb');
        t.classList.remove('ok'); t.innerHTML='‚ûú'; t.style.transform='translateX(0)'; t.style.right='auto'; t.style.left='5px';
        document.getElementById('sliderContainer').classList.remove('active');
        document.getElementById('sliderText').innerText="SLIDE TO CONFIRM";
        document.getElementById('sliderText').style.color="#777";
    }

    function sendOrder() {
        const total = document.getElementById('b-grand-total').innerText;
        let addr = isPickupMode ? "Self Pickup (Dukan se lenge)" : (document.getElementById('deliveryAddr').value ? document.getElementById('deliveryAddr').value + " (Delivery)" : "Delivery (No Address)");
        const items = []; for(let id in cart) items.push({n:products.find(x=>x.id==id).name, q:cart[id]});
        const ord = {c:user.name, p:user.phone, addr:addr, t:total, i:items, date:new Date().toLocaleString()};
        db.collection("orders").add(ord).then(()=>{
            const link = window.location.href.split('?')[0]+'?order='+btoa(JSON.stringify(ord));
            const msg = `*New Order: ‚Çπ${total}*\nüë§ ${user.name}\nüìã ${isPickupMode?'PICKUP':'DELIVERY'}\nüìç ${addr}\nüõí Items: ${items.length}\nüßæ Bill: ${link}`;
            window.open(`https://wa.me/6392728836?text=${encodeURIComponent(msg)}`, '_blank');
            cart={}; render(); updateFooter(); document.getElementById('bill-modal').style.display='none';
        });
    }

    function showOrders() {
        const h = document.getElementById('history-list'); h.innerHTML='Loading...';
        document.getElementById('history-modal').style.display='flex';
        db.collection("orders").orderBy("date","desc").limit(20).get().then(s=>{
            h.innerHTML=''; s.forEach(d=>{ const v=d.data(); 
                if(v.type === 'parchi') {
                    h.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee;">üì∏ <b>Parchi Order</b><br>${v.date.split(',')[0]} - ${v.c}<br><a href="?parchi=${d.id}">View Photo</a></div>`;
                } else {
                    h.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee;"><b>‚Çπ${v.t}</b> - ${v.date.split(',')[0]}<br><span style="font-size:12px; color:gray;">${v.addr}</span></div>`; 
                }
            });
        });
    }

    function showBillMode() {
        try {
            const d = JSON.parse(atob(new URLSearchParams(window.location.search).get('order')));
            let h=''; d.i.forEach(x=>h+=`<div>${x.n} x${x.q}</div>`);
            document.body.innerHTML=`<div style="padding:20px;font-family:sans-serif;text-align:center;"><h2>Invoice</h2><p>Customer: ${d.c}</p><div style="border:1px solid #ddd;padding:10px;margin:20px 0;">${h}</div><h3>Total: ‚Çπ${d.t}</h3><p>${d.addr}</p><a href="${window.location.href.split('?')[0]}">Home</a></div>`;
        } catch(e){location.href=location.href.split('?')[0]}
    }
</script>
</body>
</html>
