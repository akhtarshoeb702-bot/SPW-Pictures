<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raju Kirana (Premium UI)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root { 
            --primary: #6c5ce7; --secondary: #a29bfe; --accent: #00b894;
            --bg: #dfe6e9; --text: #2d3436; --card-bg: rgba(255, 255, 255, 0.95); 
            --glass: blur(16px) saturate(180%); --radius: 20px;
        }
        body.dark-mode { 
            --bg: #0f0c29; --text: #dfe6e9; --card-bg: rgba(30, 30, 30, 0.9); 
            --primary: #8e44ad;
        }
        body { font-family: 'Outfit', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 120px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* HEADER */
        .header { position: sticky; top: 0; z-index: 1000; padding: 15px 20px 10px; background: rgba(255,255,255,0.85); backdrop-filter: blur(15px); box-shadow: 0 4px 20px rgba(0,0,0,0.03); animation: slideDown 0.6s ease-out; }
        .dark-mode .header { background: rgba(15, 12, 41, 0.9); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .brand { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; animation: fadeIn 1s ease; }
        
        /* ICONS & RIPPLE */
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.05); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
        .icon-btn:active { transform: scale(0.8); }
        .cart-icon-box { position: relative; margin: 0 10px; cursor: pointer; padding: 5px; transition: 0.3s; }
        .cart-icon-box.bump { animation: cartBounce 0.5s ease; }
        .cart-badge { position: absolute; top: -5px; right: -8px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: none; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; animation: popIn 0.4s; }

        /* BUTTONS */
        .btn-small { background: var(--text); color: var(--bg); border: none; padding: 8px 16px; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .btn-small:active { transform: scale(0.95); }
        .qty-compact { display: flex; align-items: center; background: var(--primary); color: white; border-radius: 10px; height: 32px; padding: 0 4px; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); animation: popIn 0.3s backwards; }
        .qty-btn-c { width: 28px; height: 100%; background: transparent; border: none; color: white; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* PARCHI FAB */
        .parchi-fab { position: fixed; bottom: 100px; left: 20px; background: #ff7675; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 10px 25px rgba(255, 118, 117, 0.4); z-index: 2000; cursor: pointer; animation: floatPulse 3s infinite ease-in-out; transition: 0.3s; }
        .parchi-fab:active { transform: scale(0.9); }

        /* PREMIUM DELIVERY TOGGLE (NEW DESIGN) */
        .del-toggle-box { 
            background: rgba(0,0,0,0.06); 
            padding: 5px; 
            border-radius: 30px; 
            display: flex; 
            margin-bottom: 20px; 
            position: relative;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .del-opt { 
            flex: 1; 
            padding: 12px; 
            text-align: center; 
            font-size: 14px; 
            font-weight: 700; 
            border-radius: 25px; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            opacity: 0.6; 
            color: var(--text);
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .del-opt.selected { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4); 
            opacity: 1; 
            transform: scale(1.05);
        }
        .dark-mode .del-opt.selected { background: var(--primary); color: white; }

        /* GRID & CARDS */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 15px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 12px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.5); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .card-img { height: 125px; background: rgba(0,0,0,0.03); border-radius: 16px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 10px; }
        .card img { max-width: 90%; max-height: 90%; object-fit: contain; transition: 0.5s; }
        .card:hover img { transform: scale(1.1) rotate(2deg); }
        
        /* CATEGORIES */
        .cat-row { display: flex; gap: 10px; overflow-x: auto; padding: 5px 15px 15px; scrollbar-width: none; }
        .cat-btn { background: var(--card-bg); padding: 8px 18px; border-radius: 25px; font-weight: 600; font-size: 13px; color: var(--text); border: 1px solid rgba(0,0,0,0.05); opacity: 0.7; white-space: nowrap; transition: 0.3s; }
        .cat-btn.active { background: var(--primary); color: white; opacity: 1; border-color: transparent; transform: scale(1.05); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3); }
        
        /* BOTTOM BAR */
        .cart-bar { position: fixed; bottom: 25px; left: 15px; right: 15px; background: #2d3436; color: white; padding: 12px 25px; border-radius: 22px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 3000; animation: slideUpBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .fab { position: fixed; bottom: 100px; right: 20px; background: var(--text); color: var(--bg); width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer; transition: 0.3s; animation: popIn 0.5s 1s backwards; }
        
        /* MODALS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .modal-box { background: var(--bg); color: var(--text); padding: 25px; width: 88%; max-width: 360px; border-radius: 28px; max-height: 85vh; overflow-y: auto; box-shadow: 0 30px 60px rgba(0,0,0,0.5); animation: modalSpring 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .search-box { width: 100%; padding: 14px 18px; border-radius: 14px; background: rgba(0,0,0,0.05); border: 2px solid transparent; outline: none; color: var(--text); margin-bottom: 10px; font-family: inherit; font-size: 15px; transition: 0.3s; }
        .search-box:focus { background: white; border-color: var(--primary); }
        .inp { width: 100%; padding: 15px; margin: 8px 0; border: none; border-radius: 14px; background: rgba(0,0,0,0.05); color: var(--text); font-family: inherit; font-weight: 600; transition:0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUpBounce { 0% { transform: translateY(100%); opacity: 0; } 70% { transform: translateY(-10px); } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes modalSpring { 0% { transform: scale(0.7) translateY(20px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes cardEntry { from { opacity: 0; transform: translateY(30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes cartBounce { 0% { transform: scale(1); } 40% { transform: scale(1.4) rotate(-10deg); } 80% { transform: scale(0.9); } 100% { transform: scale(1); } }
        @keyframes floatPulse { 0% { transform: translateY(0); box-shadow: 0 10px 25px rgba(255, 118, 117, 0.4); } 50% { transform: translateY(-6px); box-shadow: 0 15px 35px rgba(255, 118, 117, 0.6); } 100% { transform: translateY(0); box-shadow: 0 10px 25px rgba(255, 118, 117, 0.4); } }
        
        .fly-item { position: fixed; z-index: 9999; width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid white; pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple 0.6s linear; background: rgba(255, 255, 255, 0.4); pointer-events: none; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        .slider-container { height: 50px; background: #e0e0e0; border-radius: 25px; position: relative; overflow: hidden; margin-top: 15px; transition: 0.3s; }
        .slider-container.active { background: var(--accent); transform: scale(1.02); }
        .slider-thumb { width: 42px; height: 42px; background: white; border-radius: 50%; position: absolute; top: 4px; left: 4px; display: flex; justify-content: center; align-items: center; color: var(--primary); font-weight: bold; cursor: grab; z-index: 2; transition: transform 0.1s, background 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .toast { position: fixed; bottom: 85px; left: 50%; transform: translate(-50%, 40px); background: #2d3436; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.4s; pointer-events: none; z-index: 6000; font-size: 14px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body>

<div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9000;display:flex;justify-content:center;align-items:center; flex-direction:column;">
    <div style="width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #6c5ce7;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
</div>
<style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
<div id="toast" class="toast">Success</div>

<div id="login-view" class="overlay" style="display: flex; background: var(--primary);">
    <div class="modal-box glass" style="background: rgba(255,255,255,0.98); text-align:center;">
        <div style="font-size:60px; margin-bottom:10px; animation: cartBounce 1s infinite;">üõçÔ∏è</div>
        <h2 style="color:var(--primary); margin:0 0 5px;">Raju Kirana</h2>
        <p style="margin-bottom:20px; font-size:13px; color:#777;">Aapki Apni Digital Dukan</p>
        <input type="text" id="loginName" class="inp" placeholder="Enter Your Name">
        <input type="tel" id="loginPhone" class="inp" placeholder="Mobile Number">
        <button class="btn-small ripple-btn" style="width:100%; padding:15px; font-size:16px; margin-top:10px;" onclick="handleLogin()">Login to Shop</button>
    </div>
</div>

<div id="app-view" style="display:none;">
    <div class="header">
        <div class="top-row">
            <div class="brand">üõçÔ∏è Raju Kirana</div>
            <div style="display:flex; align-items:center;">
                <div class="icon-btn ripple-btn" onclick="shareApp()" style="margin-right:8px;" title="Share App">üì§</div>
                <div class="cart-icon-box" id="header-cart" onclick="openBillPreview()">
                    <span style="font-size:24px;">üõí</span>
                    <div id="cart-badge" class="cart-badge">0</div>
                </div>
                <div class="icon-btn ripple-btn" onclick="toggleTheme()" style="margin-right:8px;">üåì</div>
                <div onclick="handleLogout()" style="padding:8px 12px; background:rgba(0,0,0,0.05); border-radius:18px; font-size:11px; font-weight:700; cursor:pointer;">EXIT</div>
            </div>
        </div>
        <input type="text" id="search" class="search-box" placeholder="Search atta, dal, rice..." onkeyup="render()">
    </div>

    <div id="admin-panel" style="display:none; padding:0 15px; animation: fadeIn 1s;">
        <div class="admin-dash">
            <h3 style="margin:0; font-size:18px;">Business Panel üõ°Ô∏è</h3>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <div>Total Products<br><b style="font-size:22px;" id="adm-prod-count">0</b></div>
                <div style="text-align:right;">Status<br><b style="font-size:22px; color:#55efc4;">Active</b></div>
            </div>
            <button class="btn-small ripple-btn" style="background:rgba(255,255,255,0.25); width:100%; margin-top:15px; color:white;" onclick="showOrders()">View Order History</button>
        </div>
    </div>

    <div class="cat-row">
        <button class="cat-btn active ripple-btn" onclick="filter('All', this)">All</button>
        <button class="cat-btn ripple-btn" onclick="filter('Rashan', this)">Rashan</button>
        <button class="cat-btn ripple-btn" onclick="filter('Snacks', this)">Snacks</button>
        <button class="cat-btn ripple-btn" onclick="filter('Offers', this)">Offers</button>
    </div>

    <div class="grid" id="grid"></div>
    
    <div class="fab ripple-btn" id="admin-fab" style="display:none;" onclick="openAddModal()">+</div>
    
    <div class="parchi-fab ripple-btn" onclick="document.getElementById('parchiInput').click()">üì∑</div>
    <input type="file" id="parchiInput" hidden accept="image/*" capture="environment" onchange="handleParchiUpload()">

    <div class="cart-bar" id="cart-bar" style="display:none;">
        <div><div style="font-size:11px; opacity:0.7;">TOTAL</div><div style="font-size:20px; font-weight:800;">‚Çπ<span id="cart-total">0</span></div></div>
        <div onclick="openBillPreview()" class="ripple-btn" style="background:white; color:black; padding:10px 24px; border-radius:25px; font-weight:700; font-size:14px; cursor:pointer;">Checkout ‚ûú</div>
    </div>
</div>

<div id="parchi-modal" class="overlay">
    <div class="modal-box">
        <h3>Parchi Order üìù</h3>
        <p style="font-size:12px; color:gray; margin-bottom:10px;">Photo click karke bhejein.</p>
        <img id="parchiPreview" src="" style="width:100%; height:200px; object-fit:contain; background:#f5f5f5; border-radius:10px; margin-bottom:15px;">
        <button id="sendParchiBtn" class="btn-small ripple-btn" style="width:100%; padding:15px; font-size:16px;" onclick="sendParchi()">Send to Raju üöÄ</button>
        <button onclick="document.getElementById('parchi-modal').style.display='none'" style="margin-top:10px; background:none; border:none; color:var(--text); width:100%;">Cancel</button>
    </div>
</div>

<div id="add-modal" class="overlay">
    <div class="modal-box">
        <h3>Add Product</h3>
        <input type="file" id="fileInput" hidden onchange="handleImageUpload()">
        <div onclick="document.getElementById('fileInput').click()" style="border:2px dashed var(--primary); padding:20px; text-align:center; border-radius:15px; margin-bottom:15px; cursor:pointer; color:var(--primary); background:rgba(108, 92, 231, 0.05);">üì∏ Upload Photo</div>
        <img id="imgPreview" src="" style="display:none; width:100%; height:120px; object-fit:contain; margin-bottom:15px; border-radius:10px;">
        <input type="text" id="pName" class="inp" placeholder="Product Name">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="text" id="pUnit" class="inp" placeholder="Unit (e.g. 1kg)">
            <input type="number" id="pPrice" class="inp" placeholder="Price (‚Çπ)">
        </div>
        <select id="pCat" class="inp"><option>Rashan</option><option>Snacks</option><option>Offers</option></select>
        <button id="saveBtn" class="btn-small ripple-btn" style="width:100%; font-size:16px; padding:15px; margin-top:10px;" onclick="saveProduct()">Save Product</button>
        <button onclick="document.getElementById('add-modal').style.display='none'" style="margin-top:10px; background:none; border:none; color:var(--text); width:100%; font-weight:600;">Cancel</button>
    </div>
</div>

<div id="bill-modal" class="overlay">
    <div class="modal-box">
        <h2 style="margin:0 0 20px;">Invoice üßæ</h2>
        
        <div class="del-toggle-box">
            <div id="opt-del" class="del-opt selected" onclick="toggleDeliveryMode('delivery')">üöö Delivery</div>
            <div id="opt-pick" class="del-opt" onclick="toggleDeliveryMode('pickup')">üè¨ Pickup</div>
        </div>

        <div style="background:white; color:#333; padding:20px; border-radius:18px; box-shadow:0 5px 20px rgba(0,0,0,0.05); margin-bottom:20px;">
            <div id="bill-list" style="max-height:25vh; overflow-y:auto; border-bottom:1px solid #eee; margin-bottom:10px;"></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;"><span>Items Total</span><span>‚Çπ<span id="b-item-total">0</span></span></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; color:var(--primary); margin-bottom:10px;"><span>Delivery Fee</span><span id="b-delivery">‚Çπ0</span></div>
            <div style="display:flex; justify-content:space-between; font-weight:800; font-size:20px; padding-top:10px; border-top:2px dashed #ccc;"><span>Payable</span><span>‚Çπ<span id="b-grand-total">0</span></span></div>
        </div>
        <div id="addr-section"><textarea id="deliveryAddr" class="inp" rows="2" placeholder="üìç Enter Village Name / Landmark"></textarea></div>
        <div id="pickup-msg" style="display:none; text-align:center; color:green; font-weight:700; font-size:14px; margin-bottom:10px; background:#e0ffe0; padding:10px; border-radius:10px;">‚úÖ You will pick up from Shop</div>
        <div class="slider-container" id="sliderContainer"><div class="slider-thumb" id="sliderThumb">‚ûú</div><div id="sliderText" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; font-weight:700; color:#777; pointer-events:none;">SLIDE TO CONFIRM ORDER</div></div>
        <button onclick="document.getElementById('bill-modal').style.display='none'" style="margin-top:15px; background:none; border:none; color:var(--text); width:100%; font-weight:600;">Close</button>
    </div>
</div>

<div id="history-modal" class="overlay"><div class="modal-box"><h3>Order History</h3><div id="history-list"></div><button class="btn-small ripple-btn" style="width:100%; margin-top:15px; background:#333;" onclick="document.getElementById('history-modal').style.display='none'">Close</button></div></div>

<script>
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('ripple-btn') || e.target.closest('.ripple-btn')) {
            const btn = e.target.classList.contains('ripple-btn') ? e.target : e.target.closest('.ripple-btn');
            const circle = document.createElement('span');
            const diameter = Math.max(btn.clientWidth, btn.clientHeight);
            const radius = diameter / 2;
            const rect = btn.getBoundingClientRect();
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.clientX - rect.left - radius}px`;
            circle.style.top = `${e.clientY - rect.top - radius}px`;
            circle.classList.add('ripple');
            const ripple = btn.getElementsByClassName('ripple')[0];
            if (ripple) { ripple.remove(); }
            btn.appendChild(circle);
        }
    });

    const firebaseConfig = { apiKey: "AIzaSyAYKEYZZVtq9e8k9LemxxSBEDU9oie7vjI", authDomain: "raju-kirana.firebaseapp.com", projectId: "raju-kirana", storageBucket: "raju-kirana.firebasestorage.app", messagingSenderId: "9931410245", appId: "1:9931410245:web:97e3237c29a85c06e84c2c" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let products = [], cart = {}, user = null, isAdmin = false, activeCat = 'All';
    let tempImgBase64 = "", parchiImgBase64 = "", isPickupMode = false;
    const ADMIN_PIN = "1234";

    window.onload = function() {
        if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
        const u = localStorage.getItem('raju_user');
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('order')) showBillMode();
        else if(urlParams.get('parchi')) showParchiMode();
        else if(u) {
            user = JSON.parse(u);
            if(user.name === "Admin" && user.phone === "6392") isAdmin = true;
            showApp();
        } else { document.getElementById('loader').style.display='none'; }
        initSlider();
    };

    function showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }

    function handleLogin() {
        const n = document.getElementById('loginName').value.trim();
        const p = document.getElementById('loginPhone').value.trim();
        if(!n || !p) { showToast("Fill all details!"); return; }
        if(n === "Admin" && p === "6392") {
            const pin = prompt("Enter Admin PIN:");
            if(pin !== ADMIN_PIN) { showToast("Wrong PIN!"); return; }
        } else if (p.length !== 10) { showToast("Invalid Mobile Number"); return; }
        user = {name:n, phone:p}; localStorage.setItem('raju_user', JSON.stringify(user)); location.reload();
    }
    function handleLogout() { localStorage.removeItem('raju_user'); location.reload(); }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); }

    function shareApp() {
        const shareData = { title: 'Raju Kirana', text: 'Order rashan online!', url: window.location.href.split('?')[0] };
        if (navigator.share) navigator.share(shareData).catch(console.error);
        else window.open(`https://wa.me/?text=${encodeURIComponent(shareData.text + " " + shareData.url)}`, '_blank');
    }

    function showApp() {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        if(isAdmin) { document.getElementById('admin-fab').style.display='flex'; document.getElementById('admin-panel').style.display='block'; }
        db.collection("products").onSnapshot(snap => {
            products = []; snap.forEach(d => products.push({id:d.id, ...d.data()}));
            render(); 
            if(isAdmin) document.getElementById('adm-prod-count').innerText = products.length;
            document.getElementById('loader').style.display='none';
        });
    }

    function render() {
        const g = document.getElementById('grid'); g.innerHTML = '';
        const term = document.getElementById('search').value.toLowerCase();
        const filtered = products.filter(p => (activeCat==='All'||p.cat===activeCat) && p.name.toLowerCase().includes(term));
        if(filtered.length === 0) { g.innerHTML = `<div class="empty-state" style="grid-column:1/-1;text-align:center;padding:20px;opacity:0.6;font-size:20px;">üçû<br>No items found</div>`; return; }
        
        filtered.forEach((p, index) => {
            const q = cart[p.id]||0;
            const btn = q===0 ? `<button class="btn-small ripple-btn" onclick="updateQty('${p.id}',1)">ADD</button>` : `<div class="qty-compact"><button class="qty-btn-c" onclick="updateQty('${p.id}',-1)">‚àí</button><span style="font-size:12px; font-weight:700; min-width:15px; text-align:center;">${q}</span><button class="qty-btn-c" onclick="updateQty('${p.id}',1)">+</button></div>`;
            const delBtn = isAdmin ? `<div style="position:absolute;top:5px;right:5px;background:rgba(255,255,255,0.8);padding:4px;border-radius:50%;font-size:10px;cursor:pointer;" onclick="delProd('${p.id}')">üóëÔ∏è</div>` : '';
            g.innerHTML += `<div class="card" style="animation: cardEntry 0.5s ease backwards ${index * 0.05}s;">${delBtn}<div class="card-img"><img id="img-${p.id}" src="${p.img}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'"></div><div style="font-weight:700; font-size:14px; line-height:1.2;">${p.name}</div><div style="font-size:11px;color:gray; margin-bottom:5px;">${p.unit}</div><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:800;color:var(--primary);">‚Çπ${p.price}</span>${btn}</div></div>`;
        });
    }

    function flyToCart(id) {
        const img = document.getElementById(`img-${id}`);
        const cartIcon = document.getElementById('header-cart');
        if (img && cartIcon) {
            const iRect = img.getBoundingClientRect();
            const cRect = cartIcon.getBoundingClientRect();
            const c = img.cloneNode();
            c.classList.add('fly-item');
            c.style.top = `${iRect.top}px`; c.style.left = `${iRect.left}px`; c.style.width = `${iRect.width}px`;
            document.body.appendChild(c);
            setTimeout(() => { c.style.top = `${cRect.top}px`; c.style.left = `${cRect.left}px`; c.style.width = '20px'; c.style.height = '20px'; c.style.opacity = '0'; }, 50);
            setTimeout(() => { c.remove(); cartIcon.classList.add('bump'); setTimeout(()=>cartIcon.classList.remove('bump'), 500); }, 750);
        }
    }

    function updateQty(id, chg) { 
        if(chg > 0) flyToCart(id);
        if(!cart[id]) cart[id]=0; cart[id]+=chg; if(cart[id]<=0) delete cart[id]; 
        render(); updateFooter(); 
    }
    
    function updateFooter() {
        let t = 0; let c = 0; for(let id in cart) { t += products.find(x=>x.id==id).price * cart[id]; c += cart[id]; }
        document.getElementById('cart-total').innerText = t;
        document.getElementById('cart-bar').style.display = t>0 ? 'flex' : 'none';
        const badge = document.getElementById('cart-badge'); if(c > 0) { badge.innerText = c; badge.style.display = 'flex'; } else { badge.style.display = 'none'; }
    }

    function openBillPreview() {
        if(Object.keys(cart).length === 0) { showToast("Cart is Empty!"); return; }
        const l = document.getElementById('bill-list'); l.innerHTML = ''; let t = 0;
        for(let id in cart) { const p = products.find(x=>x.id==id), cost = p.price*cart[id]; t+=cost; l.innerHTML += `<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px;"><span>${p.name} x${cart[id]}</span><span>‚Çπ${cost}</span></div>`; }
        document.getElementById('b-item-total').innerText = t;
        toggleDeliveryMode('delivery'); resetSlider(); document.getElementById('bill-modal').style.display = 'flex';
    }

    function toggleDeliveryMode(mode) {
        isPickupMode = (mode === 'pickup');
        const itemTotal = parseInt(document.getElementById('b-item-total').innerText);
        const delEl = document.getElementById('b-delivery');
        document.getElementById('opt-del').classList.remove('selected'); document.getElementById('opt-pick').classList.remove('selected');
        if (isPickupMode) {
            document.getElementById('opt-pick').classList.add('selected'); document.getElementById('addr-section').style.display = 'none'; document.getElementById('pickup-msg').style.display = 'block';
            delEl.innerText = "‚Çπ0"; delEl.style.color = "green"; document.getElementById('b-grand-total').innerText = itemTotal;
        } else {
            document.getElementById('opt-del').classList.add('selected'); document.getElementById('addr-section').style.display = 'block'; document.getElementById('pickup-msg').style.display = 'none';
            let fee = itemTotal < 200 ? 20 : 0; delEl.innerText = fee === 0 ? "FREE" : "‚Çπ" + fee; delEl.style.color = fee === 0 ? "green" : "red"; document.getElementById('b-grand-total').innerText = itemTotal + fee;
        }
    }

    function handleParchiUpload() {
        const f = document.getElementById('parchiInput').files[0];
        if(f) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const sc = 600/img.width; c.width=600; c.height=img.height*sc;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    parchiImgBase64 = c.toDataURL('image/jpeg',0.6);
                    document.getElementById('parchiPreview').src = parchiImgBase64;
                    document.getElementById('parchi-modal').style.display='flex';
                }
            };
            r.readAsDataURL(f);
        }
    }

    function sendParchi() {
        const btn = document.getElementById('sendParchiBtn');
        btn.innerText = "Sending..."; btn.disabled = true;
        const ord = { c: user.name, p: user.phone, type: 'parchi', img: parchiImgBase64, date: new Date().toLocaleString() };
        db.collection("orders").add(ord).then((docRef) => {
            const link = window.location.href.split('?')[0] + '?parchi=' + docRef.id;
            const msg = `*New Parchi Order* üì∏\nüë§ ${user.name}\nüìû ${user.phone}\nüîó View Photo: ${link}`;
            window.open(`https://wa.me/6392728836?text=${encodeURIComponent(msg)}`, '_blank');
            document.getElementById('parchi-modal').style.display='none'; btn.innerText = "Send to Raju üöÄ"; btn.disabled = false;
        }).catch(e => { showToast("Error sending parchi"); btn.disabled = false; });
    }

    function showParchiMode() {
        const id = new URLSearchParams(window.location.search).get('parchi');
        document.body.innerHTML = `<div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9000;display:flex;justify-content:center;align-items:center;">Loading Parchi...</div>`;
        db.collection("orders").doc(id).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                document.body.innerHTML = `<div style="padding:20px;text-align:center;font-family:sans-serif;"><h2>Parchi Order</h2><p>${d.c} | ${d.p}</p><img src="${d.img}" style="width:100%;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);"><br><br><a href="${window.location.href.split('?')[0]}" style="background:#6c5ce7;color:white;padding:10px 20px;text-decoration:none;border-radius:20px;">Go Home</a></div>`;
            } else { document.body.innerHTML = "Order not found"; }
        });
    }

    function handleImageUpload() {
        const f = document.getElementById('fileInput').files[0];
        if(f) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const sc = 400/img.width; c.width=400; c.height=img.height*sc;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    tempImgBase64 = c.toDataURL('image/jpeg',0.6);
                    document.getElementById('imgPreview').src = tempImgBase64; document.getElementById('imgPreview').style.display='block';
                }
            };
            r.readAsDataURL(f);
        }
    }

    function saveProduct() {
        const n = document.getElementById('pName').value, u = document.getElementById('pUnit').value, p = document.getElementById('pPrice').value;
        const img = tempImgBase64 || "https://via.placeholder.com/150";
        if(n && p) {
            document.getElementById('saveBtn').innerText="Saving...";
            db.collection("products").add({name:n, unit:u, price:parseInt(p), cat:document.getElementById('pCat').value, img:img, createdAt:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{ document.getElementById('add-modal').style.display='none'; showToast("Product Saved!"); document.getElementById('saveBtn').innerText="Save Product"; document.getElementById('pName').value=''; tempImgBase64=""; document.getElementById('imgPreview').style.display='none'; });
        }
    }
    
    function delProd(id) { if(confirm("Delete?") && prompt("Admin PIN:")===ADMIN_PIN) db.collection("products").doc(id).delete(); }
    function openAddModal() { document.getElementById('add-modal').style.display='flex'; }
    function filter(c, b) { activeCat=c; document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(); }
    
    function initSlider() {
        const t = document.getElementById('sliderThumb'), c = document.getElementById('sliderContainer');
        let isDrag=false, startX;
        t.addEventListener('touchstart', e=>{if(!t.classList.contains('ok')){isDrag=true; startX=e.touches[0].clientX;}});
        t.addEventListener('mousedown', e=>{if(!t.classList.contains('ok')){isDrag=true; startX=e.clientX;}});
        const move = (cx) => { if(!isDrag) return; let x = cx - startX; let max = c.offsetWidth - t.offsetWidth - 10; if(x<0) x=0; if(x>max) x=max; t.style.transform = `translateX(${x}px)`; if(x > max*0.9) { isDrag=false; finishSlider(); } }
        document.addEventListener('touchmove', e=>move(e.touches[0].clientX)); document.addEventListener('mousemove', e=>move(e.clientX));
        document.addEventListener('touchend', ()=>{if(isDrag){isDrag=false; t.style.transform='translateX(0)';}}); document.addEventListener('mouseup', ()=>{if(isDrag){isDrag=false; t.style.transform='translateX(0)';}});
    }
    
    function finishSlider() {
        const t = document.getElementById('sliderThumb');
        t.classList.add('ok'); t.innerHTML='‚úî'; t.style.left='auto'; t.style.right='5px';
        document.getElementById('sliderContainer').classList.add('active');
        document.getElementById('sliderText').innerText="ORDER CONFIRMED!";
        document.getElementById('sliderText').style.color="white";
        setTimeout(sendOrder, 600);
    }
    
    function resetSlider() {
        const t = document.getElementById('sliderThumb');
        t.classList.remove('ok'); t.innerHTML='‚ûú'; t.style.transform='translateX(0)'; t.style.right='auto'; t.style.left='5px';
        document.getElementById('sliderContainer').classList.remove('active');
        document.getElementById('sliderText').innerText="SLIDE TO CONFIRM";
        document.getElementById('sliderText').style.color="#777";
    }

    function sendOrder() {
        const total = document.getElementById('b-grand-total').innerText;
        let addr = isPickupMode ? "Self Pickup (Dukan se lenge)" : (document.getElementById('deliveryAddr').value ? document.getElementById('deliveryAddr').value + " (Delivery)" : "Delivery (No Address)");
        const items = []; for(let id in cart) items.push({n:products.find(x=>x.id==id).name, q:cart[id]});
        const ord = {c:user.name, p:user.phone, addr:addr, t:total, i:items, date:new Date().toLocaleString()};
        db.collection("orders").add(ord).then(()=>{
            const link = window.location.href.split('?')[0]+'?order='+btoa(JSON.stringify(ord));
            const msg = `*New Order: ‚Çπ${total}*\nüë§ ${user.name}\nüìã ${isPickupMode?'PICKUP':'DELIVERY'}\nüìç ${addr}\nüõí Items: ${items.length}\nüßæ Bill: ${link}`;
            window.open(`https://wa.me/6392728836?text=${encodeURIComponent(msg)}`, '_blank');
            cart={}; render(); updateFooter(); document.getElementById('bill-modal').style.display='none';
        });
    }

    function showOrders() {
        const h = document.getElementById('history-list'); h.innerHTML='Loading...';
        document.getElementById('history-modal').style.display='flex';
        db.collection("orders").orderBy("date","desc").limit(20).get().then(s=>{
            h.innerHTML=''; s.forEach(d=>{ const v=d.data(); 
                if(v.type === 'parchi') {
                    h.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee;">üì∏ <b>Parchi Order</b><br>${v.date.split(',')[0]} - ${v.c}<br><a href="?parchi=${d.id}">View Photo</a></div>`;
                } else {
                    h.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee;"><b>‚Çπ${v.t}</b> - ${v.date.split(',')[0]}<br><span style="font-size:12px; color:gray;">${v.addr}</span></div>`; 
                }
            });
        });
    }

    function showBillMode() {
        try {
            const d = JSON.parse(atob(new URLSearchParams(window.location.search).get('order')));
            let h=''; d.i.forEach(x=>h+=`<div>${x.n} x${x.q}</div>`);
            document.body.innerHTML=`<div style="padding:20px;font-family:sans-serif;text-align:center;"><h2>Invoice</h2><p>Customer: ${d.c}</p><div style="border:1px solid #ddd;padding:10px;margin:20px 0;">${h}</div><h3>Total: ‚Çπ${d.t}</h3><p>${d.addr}</p><a href="${window.location.href.split('?')[0]}">Home</a></div>`;
        } catch(e){location.href=location.href.split('?')[0]}
    }
</script>
</body>
</html>
