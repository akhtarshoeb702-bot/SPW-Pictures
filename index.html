<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raju kirana Store</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a00e0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 

    <style>
        :root { --primary: #4a00e0; --bg: #f3e5f5; --text: #1a1a1a; }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #8e2de2, #4a00e0); color: var(--text); min-height: 100vh; padding-bottom: 120px; background-attachment: fixed; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 8px 32px 0 rgba(0,0,0,0.2); }
        .header { position: sticky; top: 0; z-index: 1000; padding: 15px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; color: rgb(0, 0, 0); margin-bottom: 10px; }
        .brand { font-size: 22px; font-weight: 800; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid white; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; }
        .search-box { width: 100%; padding: 12px; border: none; border-radius: 12px; background: rgba(255,255,255,0.95); font-size: 15px; outline: none; }
        .cat-row { display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px; scrollbar-width: none; }
        .cat-btn { background: rgba(255, 255, 255, 0.25); border: 1px solid rgba(255,255,255,0.4); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; white-space: nowrap; color: white; transition: 0.2s; }
        .cat-btn.active { background: white; color: var(--primary); font-weight: 800; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 20px; }
        .card { border-radius: 16px; padding: 10px; display: flex; flex-direction: column; position: relative; transition: 0.3s; animation: fadeUp 0.5s ease; }
        .card-img { height: 120px; background: white; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; overflow: hidden; }
        .card img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .card h3 { font-size: 14px; margin: 0 0 5px; height: 40px; overflow: hidden; font-weight: 600; line-height: 1.3; }
        .price { font-size: 16px; font-weight: 800; color: var(--primary); }
        .qty-ctrl { display: flex; align-items: center; background: var(--primary); color: white; border-radius: 8px; height: 30px; }
        .qty-btn { background: none; border: none; color: white; width: 25px; font-size: 18px; }
        .qty-val { font-size: 13px; font-weight: 700; padding: 0 5px; }
        .add-btn { background: var(--primary); color: white; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; border: none; cursor: pointer; }
        .admin-tools { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10; }
        .icon-btn { width: 28px; height: 28px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 14px; cursor: pointer; }
        .fab { position: fixed; bottom: 100px; right: 20px; background: white; color: var(--primary); width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer; }
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #1e1e1e; color: white; padding: 15px 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 3000; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-box { background: rgba(255,255,255,0.98); padding: 25px; width: 85%; max-width: 320px; border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; max-height: 80vh; overflow-y: auto; }
        .inp { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .file-upload-box { border: 2px dashed var(--primary); padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; background: #f3e5f5; color: var(--primary); font-size: 13px; font-weight: 600; }
        .preview-img { width: 100%; height: 100px; object-fit: contain; margin-top: 10px; display: none; border-radius: 8px; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 6000; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); font-weight: bold; }
        
        /* New Styles for OTP */
        .step-hidden { display: none; }
        #recaptcha-container { margin: 10px auto; }
    </style>
</head>
<body>

<div id="loader">üîÑ Working...</div>

<div id="login-view" class="overlay" style="display: flex;">
    <div class="modal-box">
        <h1 style="margin:0; font-size:40px;">üõçÔ∏è</h1>
        <h2 style="color:var(--primary); margin: 5px 0 20px;">Raju Royal Store</h2>
        
        <div id="step-phone">
            <input type="text" id="loginName" class="inp" placeholder="Your Name">
            <input type="tel" id="loginPhone" class="inp" placeholder="+91 Mobile Number" value="+91">
            <div id="recaptcha-container"></div>
            <button class="btn-main" onclick="sendOTP()" id="sendOtpBtn">Send OTP üì≤</button>
        </div>

        <div id="step-otp" class="step-hidden">
            <p style="font-size:12px; color:#666;">Enter OTP sent to your phone</p>
            <input type="number" id="otpInput" class="inp" placeholder="XXXXXX">
            <button class="btn-main" onclick="verifyOTP()">Verify & Login ‚úÖ</button>
            <button onclick="location.reload()" style="margin-top:10px; background:transparent; border:none; color:red; font-size:12px;">Try Again</button>
        </div>

        <p style="font-size:11px; color:#888; margin-top:15px;">Name / Phone no</p>
    </div>
</div>

<div id="app-view" style="display:none;">
    <div class="header glass">
        <div class="top-row">
            <div class="brand">Raju Kirana Store</div>
            <div class="logout-btn" onclick="handleLogout()">Logout</div>
        </div>
        <input type="text" id="search" class="search-box" placeholder="üîç Search..." onkeyup="render()">
    </div>

    <div class="cat-row">
        <button class="cat-btn active" onclick="filter('All', this)">All</button>
        <button class="cat-btn" onclick="filter('Rashan', this)">Rashan</button>
        <button class="cat-btn" onclick="filter('Snacks', this)">Snacks</button>
        <button class="cat-btn" onclick="filter('Household', this)">Futkar</button>
    </div>

    <div class="grid" id="grid">
        <div style="text-align:center; width:200%; padding:20px; color:white;">Loading Products from Cloud... ‚òÅÔ∏è</div>
    </div>
    
    <div class="fab" id="admin-fab" style="display:none;" onclick="openAddModal()">+</div>

    <div class="cart-bar" id="cart-bar" style="display: none;">
        <div>
            <div style="font-size:12px; color:#aaa;"><span id="count">0</span> Items</div>
            <div style="font-size:18px; font-weight:bold;">‚Çπ<span id="total">0</span></div>
        </div>
        <div onclick="openBillPreview()" style="cursor:pointer; font-weight:bold; background:white; color:black; padding:8px 15px; border-radius:20px;">Check Bill üìÑ</div>
    </div>
</div>

<div id="add-modal" class="overlay">
    <div class="modal-box">
        <h3>Add Product (Global)</h3>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewImage()">
        <div class="file-upload-box" onclick="document.getElementById('fileInput').click()">üì∏ Upload Photo</div>
        <img id="imgPreview" class="preview-img" src="">
        <input type="text" id="pName" class="inp" placeholder="Product Name">
        <input type="number" id="pPrice" class="inp" placeholder="Price (‚Çπ)">
        <select id="pCat" class="inp"><option>Rashan</option><option>Snacks</option><option>Futkar</option></select>
        <button class="btn-main" onclick="addProductToFirebase()">Save to Cloud ‚òÅÔ∏è</button>
        <button onclick="closeAddModal()" style="margin-top:10px; background:transparent; border:none; color:#666;">Cancel</button>
    </div>
</div>

<div id="bill-modal" class="overlay">
    <div class="modal-box">
        <h2 style="color:var(--primary); margin-top:0;">üßæ Confirm Order</h2>
        <div id="bill-list" style="max-height: 200px; overflow-y: auto;"></div>
        <div style="display:flex; justify-content:space-between; font-weight:800; font-size:18px; margin-top:15px; border-top:2px solid #333; padding-top:10px;">
            <span>Total:</span><span>‚Çπ<span id="bill-grand-total">0</span></span>
        </div>
        <button class="btn-main" onclick="finalOrderWhatsApp()">‚úÖ Order on WhatsApp</button>
        <button onclick="document.getElementById('bill-modal').style.display='none'" style="margin-top:10px; width:100%; padding:10px; background:#eee; border:none; border-radius:10px;">Close</button>
    </div>
</div>

<script>
    // ******************************************************
    // üëá YAHAN APNA FIREBASE CODE PASTE KAREIN üëá
    // ******************************************************
    
  const firebaseConfig = {
  apiKey: "AIzaSyAYKEYZZVtq9e8k9LemxxSBEDU9oie7vjI",
  authDomain: "raju-kirana.firebaseapp.com",
  projectId: "raju-kirana",
  storageBucket: "raju-kirana.firebasestorage.app",
  messagingSenderId: "9931410245",
  appId: "1:9931410245:web:97e3237c29a85c06e84c2c"
};
    
    // ******************************************************

    // Initialize Firebase
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth(); // Auth initialized

    let products = [];
    let cart = {};
    let user = null;
    let isAdmin = false;
    let activeCat = 'All';
    let tempImgBase64 = "";
    let confirmationResult = null; // To store OTP result

    window.onload = function() {
        const savedUser = localStorage.getItem('raju_user');
        if(new URLSearchParams(window.location.search).get('order')) { showBillMode(); }
        else if(savedUser) {
            user = JSON.parse(savedUser);
            checkAdmin();
            showApp();
        } else { 
            document.getElementById('login-view').style.display = 'flex'; 
            setupRecaptcha(); // Setup Recaptcha on load
        }
    };

    // 1. Setup Invisible Recaptcha
    function setupRecaptcha() {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible',
            'callback': (response) => {
                // reCAPTCHA solved, allow signInWithPhoneNumber.
            }
        });
    }

    // 2. Send OTP
    function sendOTP() {
        const name = document.getElementById('loginName').value;
        const phone = document.getElementById('loginPhone').value;

        // Admin Bypass (Testing purpose)
        if(name === "Admin" && phone === "6392") {
            completeLogin("Admin", "6392");
            return;
        }

        if(!name || !phone || phone.length < 10) { alert("Please enter Name and valid Phone (+91...)"); return; }

        document.getElementById('sendOtpBtn').innerText = "Sending...";
        const appVerifier = window.recaptchaVerifier;

        auth.signInWithPhoneNumber(phone, appVerifier)
            .then((result) => {
                // OTP Sent
                confirmationResult = result;
                document.getElementById('step-phone').classList.add('step-hidden');
                document.getElementById('step-otp').classList.remove('step-hidden');
                alert("OTP sent to " + phone);
            }).catch((error) => {
                alert("Error sending OTP: " + error.message);
                document.getElementById('sendOtpBtn').innerText = "Send OTP üì≤";
                window.recaptchaVerifier.render().then(function(widgetId) {
                  grecaptcha.reset(widgetId); // Reset recaptcha on error
                });
            });
    }

    // 3. Verify OTP
    function verifyOTP() {
        const code = document.getElementById('otpInput').value;
        const name = document.getElementById('loginName').value;
        
        if(!code) { alert("Enter OTP"); return; }

        confirmationResult.confirm(code).then((result) => {
            // User signed in successfully.
            const userObj = result.user;
            completeLogin(name, userObj.phoneNumber);
        }).catch((error) => {
            alert("Invalid OTP");
        });
    }

    function completeLogin(name, phone) {
        user = { name: name, phone: phone };
        localStorage.setItem('raju_user', JSON.stringify(user));
        checkAdmin();
        showApp();
    }

    function checkAdmin() {
        if(user.name === "Admin" && (user.phone === "+916392000000" || user.phone === "0000")) isAdmin = true; // Replace with your real phone number for admin
    }

    function listenToProducts() {
        db.collection("products").onSnapshot((snapshot) => {
            products = [];
            snapshot.forEach((doc) => { products.push({ id: doc.id, ...doc.data() }); });
            render(); document.getElementById('loader').style.display = 'none';
        });
    }

    function handleLogout() { localStorage.removeItem('raju_user'); auth.signOut(); location.reload(); }
    
    function showApp() {
        document.getElementById('login-view').style.display = 'none'; document.getElementById('app-view').style.display = 'block';
        if(isAdmin) document.getElementById('admin-fab').style.display = 'flex';
        document.getElementById('loader').style.display = 'block';
        listenToProducts();
    }

    function render() {
        const grid = document.getElementById('grid'); const term = document.getElementById('search').value.toLowerCase(); grid.innerHTML = '';
        const filtered = products.filter(p => (activeCat === 'All' || p.cat === activeCat) && p.name.toLowerCase().includes(term));
        if(filtered.length === 0) { grid.innerHTML = '<div style="color:white; padding:20px;">No items found.</div>'; return; }
        filtered.forEach(p => {
            const qty = cart[p.id] || 0;
            let btnHTML = qty === 0 ? `<button class="add-btn" onclick="updateQty('${p.id}', 1)">ADD</button>` : `<div class="qty-ctrl"><button class="qty-btn" onclick="updateQty('${p.id}', -1)">‚àí</button><span class="qty-val">${qty}</span><button class="qty-btn" onclick="updateQty('${p.id}', 1)">+</button></div>`;
            let adminHTML = isAdmin ? `<div class="admin-tools"><div class="icon-btn" onclick="editProd('${p.id}', '${p.name}', ${p.price})" style="color:orange">‚úèÔ∏è</div><div class="icon-btn" onclick="delProd('${p.id}')" style="color:red">üóëÔ∏è</div></div>` : '';
            const card = document.createElement('div'); card.className = 'card glass';
            card.innerHTML = `${adminHTML}<div class="card-img"><img src="${p.img}" onerror="this.src='https://via.placeholder.com/150'"></div><h3>${p.name}</h3><div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto;"><div class="price">‚Çπ${p.price}</div>${btnHTML}</div>`;
            grid.appendChild(card);
        });
    }

    function updateQty(id, change) { if(!cart[id]) cart[id] = 0; cart[id] += change; if(cart[id] <= 0) delete cart[id]; render(); updateFooter(); }
    function updateFooter() { let t = 0, c = 0; for(let id in cart) { const p = products.find(x => x.id == id); t += p.price * cart[id]; c += cart[id]; } document.getElementById('total').innerText = t; document.getElementById('count').innerText = c; document.getElementById('cart-bar').style.display = c > 0 ? 'flex' : 'none'; }

    function openAddModal() { document.getElementById('add-modal').style.display = 'flex'; }
    function closeAddModal() { document.getElementById('add-modal').style.display = 'none'; tempImgBase64 = ""; document.getElementById('imgPreview').style.display='none'; }

    function addProductToFirebase() {
        const n = document.getElementById('pName').value; const p = document.getElementById('pPrice').value; const c = document.getElementById('pCat').value; const i = tempImgBase64 || "https://via.placeholder.com/150";
        if(n && p) {
            document.getElementById('loader').style.display = 'block';
            db.collection("products").add({ name: n, price: parseInt(p), cat: c, img: i, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
            .then(() => { document.getElementById('loader').style.display = 'none'; closeAddModal(); alert("Product Added! üåç"); })
            .catch((e) => { alert("Error: " + e.message); document.getElementById('loader').style.display = 'none'; });
        }
    }

    function delProd(id) { if(confirm("Delete for Everyone?")) db.collection("products").doc(id).delete(); }
    function editProd(id, oldName, oldPrice) {
        let newPrice = prompt(`New Price for ${oldName}?`, oldPrice);
        if(newPrice) {
            let newImg = prompt("New Image URL? (Leave empty for same)", "");
            let updateData = { price: parseInt(newPrice) }; if(newImg) updateData.img = newImg;
            db.collection("products").doc(id).update(updateData);
        }
    }

    function previewImage() {
        const file = document.getElementById('fileInput').files[0];
        if(file) {
            const reader = new FileReader(); reader.onload = function(e) {
                const img = new Image(); img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const scale = 300 / img.width; canvas.width = 300; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    tempImgBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('imgPreview').src = tempImgBase64; document.getElementById('imgPreview').style.display = 'block';
                }
            }; reader.readAsDataURL(file);
        }
    }

    function filter(cat, btn) { activeCat = cat; document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); render(); }
    function openBillPreview() {
        const list = document.getElementById('bill-list'); list.innerHTML = ''; let total = 0;
        for(let id in cart) { const p = products.find(x => x.id == id); let it = p.price * cart[id]; total += it; list.innerHTML += `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px dashed #ccc;"><span>${p.name} x${cart[id]}</span><span>‚Çπ${it}</span></div>`; }
        document.getElementById('bill-grand-total').innerText = total; document.getElementById('bill-modal').style.display = 'flex';
    }
    function finalOrderWhatsApp() {
        const orderData = { c: user.name, p: user.phone, i: [] };
        for(let id in cart) { const p = products.find(x => x.id == id); orderData.i.push({n: p.name, r: p.price, q: cart[id]}); }
        const encoded = btoa(JSON.stringify(orderData));
        const link = window.location.href.split('?')[0] + '?order=' + encoded;
        window.open(`https://wa.me/919876543210?text=${encodeURIComponent(`New Order from ${user.name} (${user.phone}):\n${link}`)}`, '_blank');
        document.getElementById('bill-modal').style.display = 'none'; cart = {}; render(); updateFooter();
    }
    function showBillMode() {
        try {
            const d = JSON.parse(atob(new URLSearchParams(window.location.search).get('order')));
            let h = '', t = 0; d.i.forEach(x => { t += x.r*x.q; h += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;"><span>${x.n} x${x.q}</span><span>‚Çπ${x.r*x.q}</span></div>`});
            document.body.innerHTML = `<div style="padding:20px;background:white;min-height:100vh;color:black;"><div style="border:1px solid #ddd;padding:20px;border-radius:10px;"><h2 style="text-align:center;color:#4a00e0;">Raju Invoice</h2><p style="text-align:center;">${d.c} (${d.p})</p><hr>${h}<hr><div style="display:flex;justify-content:space-between;font-weight:bold;font-size:20px;"><span>Total</span><span>‚Çπ${t}</span></div></div><button onclick="window.location.href=window.location.href.split('?')[0]" style="width:100%;padding:15px;background:#333;color:white;border:none;border-radius:10px;margin-top:20px;">üè† Home</button></div>`;
        } catch(e) { location.href = location.href.split('?')[0]; }
    }
</script>
</body>
</html>
